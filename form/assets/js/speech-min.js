const API_URL="https://silmma.com/speechAI/api/",helpText=document.querySelector(".speak-text"),textContent=document.querySelector(".text"),infoBar=document.querySelector(".speech"),infoContainer=document.querySelector(".speech-container"),btnContainer=document.querySelector(".button-container");let authToken={},speechConfig,speechRecognizer,isHold=!1,holdTimer,processTimer,noSpeechTimer,speakText="";async function getToken(){try{let e=await fetch(`https://silmma.com/speechAI/api/botRoute.php?type=${btoa("get-token")}`),t=await e.json();if("error"===t.msg){console.log("Failed or expired authentication!");return}authToken=t.result,speechConfig=SpeechSDK.SpeechConfig.fromAuthorizationToken(t.result.token,t.result.region),initializeSpeechRecognition(),btnContainer.style.display="block"}catch(o){console.error("Error fetching authentication token:",o)}}async function sendVoice(e){try{let t=await $.ajax({url:"helpers/apiRoute.php?type=fill-form",type:"POST",data:{voice:e,stepform:stepHtml},dataType:"json"});"success"===t.msg?(console.log(t.result),t.result.error?$(".stpsform.transup .error").html('<i class="fas fa-exclamation-triangle"></i> '+t.result.error).show():($(".stpsform.transup .error").hide(),$.each(t.result,function(e,t){let o=$('input[name="'+e+'"]').attr("type");if("text"==o)$('input[name="'+e+'"]').val(t);else if("date"==o)$('input[name="'+e+'"]').val(t);else if("radio"==o){let n=t.substring(0,1);n.toUpperCase(),tail=t.substring(1),$('input[name="'+e+'"][value="'+n+tail+'"]').prop("checked",!0)}else if("checkbox"==o){let i=t.substring(0,1);i.toUpperCase(),tail=t.substring(1),$('input[name="'+e+'"][value="'+i+tail+'"]').prop("checked",!0),i+tail=="No"&&$('input[name="'+e+'"]').prop("checked",!1)}}))):console.error("Error in fetch response")}catch(o){throw Error("Error sending voice data: "+o.message)}}const microphone={mediaStream:null,async initialize(){try{/iPad|iPhone|iPod/.test(navigator.userAgent)&&window.MSStream;let e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});return this.mediaStream=e,!0}catch(t){return console.error("Error initializing microphone:",t),!1}},close(){if(this.mediaStream){let e=this.mediaStream.getTracks();e.forEach(e=>e.stop()),this.mediaStream=null}},isInitialized(){return!!this.mediaStream}};async function connectMicrophone(){try{if(!microphone.isInitialized()){let e=await microphone.initialize();if(!e)return alert("Microphone access is required to use the form fill with AI. Please grant microphone permission."),!1}return!0}catch(t){return console.error("Error initializing microphone:",t),!1}}async function startSpeechRecognition(){try{await speechRecognizer.startContinuousRecognitionAsync(),$("#micButton").prop("checked",!0),helpText.style.display="block",helpText.innerHTML=loaderContent(),clearTimeout(processTimer),clearTimeout(noSpeechTimer)}catch(e){console.error("Error:",e)}}function initializeSpeechRecognition(){let e=SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();speechConfig.speechRecognitionLanguage="en-US",speechConfig.enableDictation(),speechConfig.setProfanity(SpeechSDK.ProfanityOption.Removed),speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceResponse_StablePartialResultThreshold,"0"),speechConfig.setProperty(SpeechSDK.PropertyId.Speech_SegmentationSilenceTimeoutMs,"5000"),(speechRecognizer=new SpeechSDK.SpeechRecognizer(speechConfig,e)).recognizing=(e,t)=>{console.log("Recognizing:"+t.result.text),helpText.textContent=speakText+" "+t.result.text,helpText.scrollTop=helpText.scrollHeight},speechRecognizer.recognized=(e,t)=>{t.result.reason==SpeechSDK.ResultReason.RecognizedSpeech&&t.result.text?(console.log("Recognized:"+t.result.text),speakText+=" "+t.result.text):t.result.reason==SpeechSDK.ResultReason.NoMatch&&console.log("NOMATCH: Speech could not be recognized.")},speechRecognizer.canceled=(e,t)=>{console.log(`CANCELED: Reason=${t.reason}`),t.reason==SpeechSDK.CancellationReason.Error&&(console.log(`"CANCELED: ErrorCode=${t.errorCode}`),console.log(`"CANCELED: ErrorDetails=${t.errorDetails}`),console.log("CANCELED: Did you set the speech resource key and region values?")),speechRecognizer.stopContinuousRecognitionAsync()},speechRecognizer.sessionStopped=(e,t)=>{console.log("Output:"+speakText),processTimer=setTimeout(()=>{speakText?(helpText.textContent="",helpText.style.display="none",infoContainer.classList.add("below-animation"),btnContainer.style.display="none",console.log("Calling sendVoice"),sendVoice(speakText).then(()=>{speakText="",infoContainer.classList.remove("below-animation"),btnContainer.style.display="block"}).catch(e=>{console.error("Error in sendVoice:",e)})):(helpText.textContent="No speech could be recognized.",noSpeechTimer=setTimeout(()=>{helpText.textContent="",helpText.style.display="none"},1e3))},1e3)}}function handleVisibilityChange(){if(document.hidden)try{microphone.isInitialized()&&microphone.close()}catch(e){console.error("Error while closing the microphone:",e)}}function loaderContent(){return`<div class="loader-speak">
        <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>`}window.onload=async()=>{await connectMicrophone()},$(".button-container").on("mousedown touchstart",async function(e){if(e.stopPropagation(),e.preventDefault(),microphone.isInitialized())holdTimer=setTimeout(()=>{isHold=!0,startSpeechRecognition()},300);else{let t=await connectMicrophone();t||alert("Microphone access is required to use the form fill with AI. Please grant microphone permission.")}}),$(".button-container").on("mouseup touchend mouseleave",async function(e){if(clearTimeout(holdTimer),console.log(isHold),!isHold)return $("#micButton").prop("checked",!1),!1;try{await speechRecognizer.stopContinuousRecognitionAsync()}catch(t){console.error("Error stopping speech recognition:",t)}setTimeout(function(){$("#micButton").prop("checked",!1)},300),isHold=!1}),void 0!==document.hidden&&document.addEventListener("visibilitychange",handleVisibilityChange),getToken();